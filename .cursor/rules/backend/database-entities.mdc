---
title: Database Entities and Relationships
description: Documentation of TypeORM entities, their relationships, and database schema patterns in the Netagram project
tags:
  [
    database,
    typeorm,
    entities,
    relationships,
    postgresql,
    social-features,
    feed,
    friend,
    group,
  ]
---

# Database Entities and Relationships

## Entity Overview

The project uses multiple entities with a clear hierarchy and relationship structure, including core user management, social features, business cards, and content sharing:

### 1. User Entity (Authentication Layer)

**Table:** `user`
**Purpose:** Platform-based authentication and user identification

```typescript
@Entity('user')
export class User {
  @PrimaryColumn({ type: 'varchar', length: 255 })
  uid: string; // Primary identifier from external platform

  @Column({ type: 'varchar', length: 255 })
  email: string;

  @Column({ type: 'varchar', length: 1 })
  platform: string; // Platform identifier (e.g., 'G' for Google)

  @Column({ type: 'varchar', length: 255 })
  pid: string; // Platform-specific user ID

  @Column({ type: 'text' })
  token: string; // Authentication token

  @Column({ type: 'varchar', length: 20, nullable: true })
  phone?: string;

  @CreateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;

  @UpdateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  updatedAt: Date;

  @OneToMany(() => BusinessCard, 'user')
  businessCards: BusinessCard[];

  @OneToMany(() => Feed, 'user')
  feeds: Feed[];

  @OneToMany(() => FeedLike, 'user')
  feedLikes: FeedLike[];

  @OneToMany(() => Friend, 'user')
  friends: Friend[];

  @OneToMany(() => Group, 'user')
  groups: Group[];
}
```

**Key Characteristics:**

- Uses `uid` as primary key (not auto-generated)
- Platform-based authentication system
- One-to-many relationships with all content entities
- Central hub for all user-generated content and social interactions

### 2. UserProfile Entity (Social Profile)

**Table:** `userProfile`
**Purpose:** Extended social profile information

```typescript
@Entity('userProfile')
export class UserProfile {
  @PrimaryGeneratedColumn('uuid')
  id: string; // Auto-generated UUID

  @Column({ type: 'varchar', length: 255 })
  uid: string; // Foreign key to User.uid

  @Column({ type: 'varchar', length: 255 })
  name: string;

  @Column({ type: 'varchar', length: 255, nullable: true })
  phone?: string;

  @Column({ type: 'varchar', length: 255, nullable: true })
  email: string;

  @Column({ type: 'varchar', length: 255, nullable: true })
  introduction: string;

  @Column({ type: 'varchar', length: 255, nullable: true })
  profileImage: string;

  @Column({ type: 'varchar', length: 255, nullable: true })
  profileImageUrl: string;

  @Column({ type: 'text', array: true, nullable: true })
  interests?: string[]; // Array of interest strings

  @Column({ type: 'varchar', length: 255, nullable: true })
  youtubeUrl: string;

  @Column({ type: 'varchar', length: 255, nullable: true })
  linkedinUrl: string;

  @Column({ type: 'varchar', length: 255, nullable: true })
  websiteUrl: string;

  @CreateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;

  @UpdateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  updatedAt: Date;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'uid' })
  user: User;
}
```

**Key Characteristics:**

- Auto-generated UUID primary key
- Many-to-one relationship with User
- Supports social media URLs and interests array
- CASCADE delete when User is removed

### 3. BusinessCard Entity (Business Cards)

**Table:** `business_card`
**Purpose:** Business card templates and information

```typescript
@Entity('business_card')
export class BusinessCard {
  @PrimaryGeneratedColumn('uuid')
  id: string; // Auto-generated UUID

  @Column({ type: 'varchar', length: 255 })
  uid: string; // Foreign key to User.uid

  @Column({ type: 'varchar', length: 100 })
  nameKorean: string;

  @Column({ type: 'varchar', length: 100 })
  nameEnglish: string;

  @Column({ type: 'varchar', length: 20 })
  phoneNumber: string;

  @Column({ type: 'varchar', length: 255 })
  email: string;

  @Column({ type: 'varchar', length: 500, nullable: true })
  profileImage: string;

  @Column({ type: 'varchar', length: 500, nullable: true })
  profileImageUrl: string;

  @Column({ type: 'enum', enum: TemplateType, nullable: true })
  templateType: TemplateType;

  @Column({ type: 'boolean', default: true })
  isActive: boolean;

  @CreateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;

  @UpdateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  updatedAt: Date;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'uid' })
  user: User;
}
```

**Key Characteristics:**

- Auto-generated UUID primary key
- Bilingual support (Korean/English names)
- Template system with enum types
- CASCADE delete when User is removed

### 4. Friend Entity (Social Relationships)

**Table:** `friend`
**Purpose:** Bidirectional friendship relationships

```typescript
@Entity('friend')
@Unique(['userId', 'friendId'])
export class Friend {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ type: 'varchar', length: 255 })
  userId: string;

  @Column({ type: 'varchar', length: 255 })
  friendId: string;

  @CreateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;

  @UpdateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  updatedAt: Date;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'userId', referencedColumnName: 'uid' })
  user: User;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'friendId', referencedColumnName: 'uid' })
  friend: User;

  @OneToMany(() => FriendGroup, 'friend')
  friendGroups?: FriendGroup[];
}
```

**Key Characteristics:**

- Unique constraint on `userId` + `friendId` prevents duplicate friendships
- Bidirectional relationships (both directions stored)
- CASCADE delete when either User is removed
- One-to-many with FriendGroup for group memberships

### 5. Group Entity (Social Groups)

**Table:** `group`
**Purpose:** Custom and interest-based social groups

```typescript
@Entity('group')
@Unique(['userId', 'groupName'])
export class Group {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ type: 'varchar', length: 255 })
  userId: string;

  @Column({ type: 'varchar', length: 255 })
  groupName: string;

  @Column({ type: 'varchar', length: 255, default: GroupType.CUSTOM })
  groupType: GroupType;

  @Column({ type: 'boolean', default: false })
  isFavorite: boolean;

  @Column({ type: 'varchar', length: 255, nullable: true })
  groupImage: string;

  @Column({ type: 'varchar', length: 255, nullable: true })
  groupImageUrl: string;

  @CreateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;

  @UpdateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  updatedAt: Date;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'userId', referencedColumnName: 'uid' })
  user: User;

  @OneToMany(() => FriendGroup, friendGroup => friendGroup.group)
  friendGroups?: FriendGroup[];
}
```

**Key Characteristics:**

- Unique constraint on `userId` + `groupName` prevents duplicate group names per user
- Two group types: CUSTOM (user-created) and INTEREST_BASED (auto-generated)
- Optional group image support
- CASCADE delete when User is removed

### 6. FriendGroup Entity (Junction Table)

**Table:** `friend_group`
**Purpose:** Many-to-many relationship between friends and groups

```typescript
@Entity('friend_group')
export class FriendGroup {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ type: 'uuid' })
  friendId: string;

  @Column({ type: 'uuid' })
  groupId: string;

  @CreateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;

  @ManyToOne(() => Friend, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'friendId', referencedColumnName: 'id' })
  friend: Friend;

  @ManyToOne(() => Group, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'groupId', referencedColumnName: 'id' })
  group: Group;
}
```

**Key Characteristics:**

- Junction table for many-to-many friend-group relationships
- CASCADE delete when Friend or Group is removed
- Enables friends to belong to multiple groups

### 7. Feed Entity (Social Content)

**Table:** `feed`
**Purpose:** Social media feed posts with flexible sharing scopes

```typescript
@Entity('feed')
export class Feed {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ type: 'varchar', length: 255 })
  userId: string; // Foreign key to User.uid

  @Column({ type: 'text' })
  content: string; // Post content (max 5000 chars)

  @Column({ type: 'text', array: true, nullable: true })
  images?: string[]; // Up to 5 image paths

  @Column({ type: 'text', array: true, nullable: true })
  imageUrls?: string[]; // Corresponding URLs

  @Column({ type: 'enum', enum: ShareScope })
  shareScope: ShareScope; // Visibility scope

  @Column({ type: 'varchar', length: 255, nullable: true })
  groupId?: string; // For GROUPS scope

  @Column({ type: 'integer', default: 0 })
  likeCount: number; // Denormalized counter

  @CreateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;

  @UpdateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  updatedAt: Date;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'userId', referencedColumnName: 'uid' })
  user: User;

  @OneToMany(() => FeedLike, feedLike => feedLike.feed)
  likes: FeedLike[];

  @OneToMany(
    () => FeedSharedWithFriend,
    feedSharedWithFriend => feedSharedWithFriend.feed,
  )
  sharedWithFriends: FeedSharedWithFriend[];

  @OneToMany(
    () => FeedSharedWithGroup,
    feedSharedWithGroup => feedSharedWithGroup.feed,
  )
  sharedWithGroups: FeedSharedWithGroup[];
}
```

**Key Characteristics:**

- Auto-generated UUID primary key
- Multi-image support (up to 5 images)
- Flexible sharing scopes (PUBLIC, FRIENDS, GROUPS)
- Denormalized like count for performance
- CASCADE delete when User is removed

### 8. FeedLike Entity (Social Interactions)

**Table:** `feed_like`
**Purpose:** Track user likes on feed posts

```typescript
@Entity('feed_like')
@Unique(['feedId', 'userId'])
export class FeedLike {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ type: 'uuid' })
  feedId: string;

  @Column({ type: 'varchar', length: 255 })
  userId: string;

  @CreateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;

  @ManyToOne(() => Feed, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'feedId', referencedColumnName: 'id' })
  feed: Feed;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'userId', referencedColumnName: 'uid' })
  user: User;
}
```

**Key Characteristics:**

- Unique constraint prevents duplicate likes
- CASCADE delete when Feed or User is removed
- Timestamp tracking for like chronology

### 9. FeedSharedWithFriend Entity (Junction Table)

**Table:** `feed_shared_with_friend`
**Purpose:** Junction table for FRIENDS share scope

```typescript
@Entity('feed_shared_with_friend')
export class FeedSharedWithFriend {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ type: 'uuid' })
  feedId: string;

  @Column({ type: 'varchar', length: 255 })
  friendId: string;

  @CreateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;

  @ManyToOne(() => Feed, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'feedId', referencedColumnName: 'id' })
  feed: Feed;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'friendId', referencedColumnName: 'uid' })
  user: User;
}
```

**Key Characteristics:**

- Only populated when shareScope = FRIENDS
- CASCADE delete when Feed or User is removed
- Enables granular sharing control

### 10. FeedSharedWithGroup Entity (Junction Table)

**Table:** `feed_shared_with_group`
**Purpose:** Junction table for GROUPS share scope

```typescript
@Entity('feed_shared_with_group')
export class FeedSharedWithGroup {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ type: 'uuid' })
  feedId: string;

  @Column({ type: 'uuid' })
  groupId: string;

  @CreateDateColumn({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;

  @ManyToOne(() => Feed, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'feedId', referencedColumnName: 'id' })
  feed: Feed;

  @ManyToOne(() => Group, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'groupId', referencedColumnName: 'id' })
  group: Group;
}
```

**Key Characteristics:**

- Only populated when shareScope = GROUPS
- CASCADE delete when Feed or Group is removed
- Enables group-based sharing

## Relationship Mappings

### Core User Relationships

**User → UserProfile**

- **Type:** One-to-One (implied by uid foreign key)
- **Cascade:** CASCADE delete
- **Join Column:** `uid`

**User → BusinessCard**

- **Type:** One-to-Many
- **Cascade:** CASCADE delete
- **Join Column:** `uid`

### Social Relationship Mappings

**User → Friend**

- **Type:** One-to-Many (bidirectional)
- **Cascade:** CASCADE delete
- **Join Column:** `userId` → `uid`
- **Note:** Both directions stored for bidirectional friendship

**User → Group**

- **Type:** One-to-Many
- **Cascade:** CASCADE delete
- **Join Column:** `userId` → `uid`

**Friend → FriendGroup**

- **Type:** One-to-Many
- **Cascade:** CASCADE delete
- **Join Column:** `friendId` → `id`

**Group → FriendGroup**

- **Type:** One-to-Many
- **Cascade:** CASCADE delete
- **Join Column:** `groupId` → `id`

### Content Relationship Mappings

**User → Feed**

- **Type:** One-to-Many
- **Cascade:** CASCADE delete
- **Join Column:** `userId` → `uid`

**User → FeedLike**

- **Type:** One-to-Many
- **Cascade:** CASCADE delete
- **Join Column:** `userId` → `uid`

**Feed → FeedLike**

- **Type:** One-to-Many
- **Cascade:** CASCADE delete
- **Join Column:** `feedId` → `id`

**Feed → FeedSharedWithFriend**

- **Type:** One-to-Many
- **Cascade:** CASCADE delete
- **Join Column:** `feedId` → `id`

**Feed → FeedSharedWithGroup**

- **Type:** One-to-Many
- **Cascade:** CASCADE delete
- **Join Column:** `feedId` → `id`

## Database Configuration

### TypeORM Settings

```typescript
{
  type: 'postgres',
  autoLoadEntities: true,
  synchronize: true,  // Development only
}
```

### Key Patterns

- **Primary Keys:** User uses `uid` (external), others use auto-generated UUIDs
- **Timestamps:** All entities have `createdAt` and `updatedAt`
- **Cascade Deletes:** Child entities are automatically deleted when User is removed
- **Nullable Fields:** Most profile fields are optional except core identifiers
- **Unique Constraints:** Prevent duplicate friendships and group names per user

## Data Flow

### User Creation Flow

1. **User Creation:** External platform provides `uid`, `platform`, `pid`
2. **Profile Creation:** UserProfile created with same `uid`
3. **Business Card Creation:** BusinessCard created with same `uid`
4. **Interest Groups:** Automatic group creation based on user interests

### Social Interaction Flow

1. **Friend Addition:** Bidirectional Friend records created
2. **Group Management:** Friends added/removed from groups via FriendGroup
3. **Feed Creation:** Feed created with specified shareScope
4. **Sharing Logic:** Junction tables populated based on shareScope
5. **Social Interactions:** FeedLike records for engagement

### Deletion Flow

1. **User Deletion:** Cascades to all related records
2. **Friend Removal:** Both directions deleted simultaneously
3. **Group Deletion:** FriendGroup associations removed
4. **Feed Deletion:** All likes and sharing records removed

## Feed Visibility Logic

The feed system implements complex visibility rules based on shareScope:

### PUBLIC Feeds

- Visible to all users
- No additional filtering required

### FRIENDS Feeds

- Only visible to users in creator's friend list
- Requires Friend entity relationship check
- Uses FeedSharedWithFriend junction table

### GROUPS Feeds

- Only visible to group members
- Requires FriendGroup relationship check
- Uses FeedSharedWithGroup junction table

## Performance Considerations

### Denormalized Counters

- `likeCount` field in Feed entity for fast like count retrieval
- Avoids expensive COUNT queries on large datasets

### Database Indexes

Recommended indexes on frequently queried fields:

- `feed.userId` (for user's feeds)
- `feed.createdAt` (for chronological ordering)
- `feed_like.feedId` (for like queries)
- `feed_like.userId` (for user's likes)
- `friend.userId` (for user's friends)
- `friend_group.groupId` (for group members)
- `friend_group.friendId` (for friend's groups)

### Query Optimization

- Use QueryBuilder for complex visibility logic
- Leverage junction tables for efficient relationship queries
- Implement proper indexing strategy for social features

## Social Features Architecture

### Bidirectional Friendship System

- Both directions of friendship stored in database
- Prevents duplicate relationship creation
- Enables efficient friend queries in both directions

### Interest-Based Grouping

- Automatic group creation based on user interests
- Interest-based groups cannot be manually deleted
- Custom groups provide user control over organization

### Flexible Sharing System

- Multiple sharing scopes for different privacy levels
- Junction tables enable granular sharing control
- Complex visibility queries handle all sharing scenarios

### Multi-Image Support

- Array-based storage for multiple images per feed
- Synchronized paths and URLs arrays
- Efficient image management and cleanup
